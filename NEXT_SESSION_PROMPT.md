# Olend DeFi 平台 - 下一个任务会话 Prompt

## 🎯 任务概述

**当前任务**: 实现高效清算系统 (任务6)  
**优先级**: 中高  
**预计时间**: 1-2周  
**状态**: 待开始  

## 📋 项目背景

Olend DeFi 是基于 Sui Network 的去中心化借贷平台，目前已完成：

### ✅ 已完成的核心功能
- **Vault 系统**: ERC-4626兼容的统一流动性管理 (Shared Object)
- **Account 系统**: 用户积分等级系统，权限控制
- **Oracle 系统**: Pyth Network 预言机集成，实时价格数据
- **LendingPool 系统**: 存取资产，动态利率模型，积分奖励
- **BorrowingPool 系统**: 高抵押率借款(最高97%)，单资产抵押支持
- **测试覆盖**: 324个测试全部通过，完整的单元测试

### 🎯 当前任务目标

实现**高效清算系统**，包括：
1. **Tick 清算机制**: 按抵押率区间分组的批量清算
2. **部分清算逻辑**: 每次清算部分抵押物直到安全
3. **低清算罚金**: 低至0.1%的清算罚金机制
4. **DEX 流动性集成**: 与 Cetus、Bluefin、DEEPBook 集成
5. **清算风险管理**: 限流、价格异常检测、失败处理

## 📁 项目结构

```
sui-olend-smart-contracts/
├── sources/
│   ├── vault.move              ✅ Shared Object, ERC-4626兼容
│   ├── account.move            ✅ 积分等级系统
│   ├── oracle.move             ✅ Pyth预言机集成
│   ├── lending_pool.move       ✅ 借贷池管理
│   ├── borrowing_pool.move     ✅ 借款池管理 (需要添加清算功能)
│   ├── liquidity.move          ✅ Registry管理
│   ├── ytoken.move             ✅ 份额凭证
│   └── ...
├── tests/                      ✅ 324个测试全部通过
└── .kiro/specs/olend-defi-platform/
    ├── requirements.md         ✅ 完整需求文档
    ├── design.md              ✅ 架构设计文档
    └── tasks.md               📍 当前任务列表
```

## 🔧 技术要求

### 核心技术栈
- **语言**: Sui Move
- **架构**: Shared Object 模式
- **测试**: 单元测试 + 集成测试
- **外部集成**: Pyth Oracle, DEX (Cetus/Bluefin/DEEPBook)

### 关键设计原则
- **安全第一**: 所有资金操作必须安全可靠
- **高效清算**: Tick机制实现批量处理
- **低成本**: 0.1%清算罚金，用户友好
- **可扩展**: 支持多DEX集成和参数调整

## 📝 具体任务清单

### 6.1 在 BorrowingPool 中实现 Tick 清算 ⏳
- [ ] 在现有 `borrowing_pool.move` 中添加清算功能
- [ ] 实现按抵押率区间分组的 Tick 清算机制
- [ ] 实现动态 Tick 大小调整（0.1%-0.5%）
- [ ] 实现同一 Tick 内的批量清算处理

### 6.2 实现部分清算逻辑 ⏳
- [ ] 实现部分清算，每次清算部分抵押物直到安全
- [ ] 实现清算比例计算，确保头寸回到安全区域
- [ ] 实现清算停止条件，达到安全界限时停止
- [ ] 实现连续多轮清算支持

### 6.3 实现低清算罚金机制 ⏳
- [ ] 实现低至0.1%的清算罚金设置
- [ ] 实现基于资产类型和市场条件的动态罚金
- [ ] 实现清算罚金在清算者和平台间的分配
- [ ] 实现清算奖励的计算和分发

### 6.4 集成外部 DEX 流动性提供 ⏳
- [ ] 实现与 Cetus、Bluefin、DEEPBook 的集成接口
- [ ] 实现清算获得的资产对在 DEX 上提供流动性
- [ ] 实现 DEX 选择策略和自动切换机制
- [ ] 实现流动性收益计算和头寸管理

### 6.5 实现清算执行流程 ⏳
- [ ] 实现清算执行者权限验证
- [ ] 实现抵押资产转换和清算交易执行
- [ ] 实现清算结果分配和头寸状态更新
- [ ] 实现清算失败处理和重试机制

### 6.6 实现清算风险管理 ⏳
- [ ] 实现清算限流，避免对池内流动性冲击
- [ ] 集成预言机进行价格异常检测
- [ ] 实现清算失败率监控和参数调整
- [ ] 实现紧急清算和管理员干预

### 6.7 编写清算系统测试 ⏳
- [ ] 在 `tests/test_borrowing_pool.move` 中添加清算测试
- [ ] 测试 Tick 清算机制的正确性
- [ ] 测试部分清算和安全停止逻辑
- [ ] 测试 DEX 集成和流动性提供
- [ ] 测试清算风险管理和异常处理

## 🔍 关键需求参考

从 `requirements.md` 中的相关需求：

### 清算系统需求 (需求6)
- **Tick清算**: 按抵押率区间分组，动态调整Tick大小
- **部分清算**: 每次清算部分抵押物，确保头寸安全
- **低罚金**: 0.1%清算罚金，用户友好
- **DEX集成**: 与主流DEX集成，提供流动性
- **风险管理**: 限流、异常检测、失败处理

## 🧪 测试要求

### 测试覆盖目标
- **单元测试**: 每个清算函数的独立测试
- **集成测试**: 与现有系统的集成测试
- **边界测试**: 极端情况和异常处理
- **性能测试**: 批量清算的性能验证

### 现有测试基础
- 当前有324个测试全部通过
- 需要在现有测试基础上扩展清算相关测试
- 确保新功能不破坏现有功能

## 📊 成功标准

### 功能标准
- [ ] 所有清算功能按需求实现
- [ ] Tick清算机制正常工作
- [ ] DEX集成成功，流动性提供正常
- [ ] 清算罚金控制在0.1%以内

### 质量标准
- [ ] 所有新增测试通过
- [ ] 代码覆盖率保持90%以上
- [ ] 无安全漏洞和资金风险
- [ ] 性能满足批量清算要求

### 集成标准
- [ ] 与现有BorrowingPool无缝集成
- [ ] 与Oracle系统正确集成
- [ ] 与Vault系统安全集成
- [ ] 不影响现有功能正常运行

## 🚀 开始指令

请按照以下步骤开始任务：

1. **环境检查**: 确认当前代码状态和测试通过情况
2. **需求分析**: 详细阅读清算系统需求 (需求6)
3. **设计规划**: 制定清算系统的技术实现方案
4. **逐步实现**: 按照6.1-6.7的顺序逐步实现功能
5. **测试验证**: 每个子任务完成后进行测试验证

## 📞 支持资源

- **需求文档**: `.kiro/specs/olend-defi-platform/requirements.md`
- **设计文档**: `.kiro/specs/olend-defi-platform/design.md`
- **任务列表**: `.kiro/specs/olend-defi-platform/tasks.md`
- **现有代码**: `sources/` 目录下的所有模块
- **测试用例**: `tests/` 目录下的测试文件

---

**准备开始实现 Olend DeFi 平台的高效清算系统！** 🚀

请确认理解任务要求，然后开始第一个子任务：**6.1 在 BorrowingPool 中实现 Tick 清算**。