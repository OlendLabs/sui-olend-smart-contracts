# Olend DeFi 借贷平台实现计划

## 任务概述

本实现计划将需求1（统一流动性管理系统）和需求2（账户管理系统）的设计转换为具体的编码任务。任务按照依赖关系排序，确保每个步骤都能在前一步的基础上进行，最终实现完整的核心功能。

## 实现任务

- [x] 1. 建立项目基础结构和核心类型定义



  - 创建 Move 项目结构，包括 sources、tests 目录
  - 定义核心错误码常量和基础类型
  - 创建项目配置文件 Move.toml
  - 建立代码风格规范，遵循 Move Book 代码质量检查清单 (https://move-book.com/guides/code-quality-checklist)
  - 设置代码格式化和 linting 规则
  - _需求: 1.1, 1.4, 2.1, 2.6_

- [ ] 2. 实现 Liquidity Module 的核心数据结构
  - [x] 2.1 实现 Registry 数据结构和基础功能




    - 定义 Registry、VaultList 结构体
    - 实现 Registry 的创建、初始化函数
    - 实现基础的 Vault 注册和查找功能
    - 编写 Registry 管理的单元测试
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ] 2.2 实现 Vault<T> 核心结构和 ERC-4626 兼容接口
    - 定义 Vault<T>、VaultStatus、DailyLimit 结构体
    - 实现 Vault 创建和初始化函数
    - 实现 ERC-4626 标准的核心函数：deposit、withdraw、totalAssets、totalSupply
    - 实现份额和资产的转换函数：convertToShares、convertToAssets
    - 编写 Vault 基础操作的单元测试
    - _需求: 1.11, 1.12, 1.13, 1.14, 1.15, 1.16_

  - [ ] 2.3 实现 YToken<T> 份额凭证系统
    - 定义 YToken<T> 结构体
    - 实现 YToken 的创建、销毁和查询功能
    - 实现 YToken 与 Vault 的关联验证
    - 编写 YToken 管理的单元测试
    - _需求: 1.7, 1.8, 1.13, 1.14_

- [ ] 3. 实现 Liquidity Module 的高级功能
  - [ ] 3.1 实现多 Vault 管理和状态控制
    - 在 Registry 中实现多 Vault 支持逻辑
    - 实现 Vault 状态管理：暂停、恢复、设置默认 Vault
    - 实现 Vault 的活跃列表管理
    - 编写多 Vault 管理的单元测试
    - _需求: 1.2, 1.3, 1.6, 1.7, 1.19, 1.20, 1.21_

  - [ ] 3.2 实现安全控制和限额管理
    - 实现每日提取限额功能
    - 实现紧急暂停机制
    - 实现版本控制和访问权限验证
    - 编写安全功能的单元测试
    - _需求: 1.16, 1.17, 1.18, 1.22, 1.23, 1.24_

  - [ ] 3.3 实现模块间交互的 Package 接口
    - 实现 borrow 和 repay 的 package 级别函数
    - 实现权限验证机制确保只有授权模块可以调用
    - 实现资产借出和归还的逻辑
    - 编写模块间交互的单元测试
    - _需求: 1.19, 1.20, 1.21, 1.22, 1.23_

- [ ] 4. 实现 Account Module 的核心数据结构
  - [ ] 4.1 实现 AccountRegistry 全局账户管理
    - 定义 AccountRegistry 结构体
    - 实现账户注册表的创建和初始化
    - 实现账户创建、查找和验证功能
    - 编写 AccountRegistry 的单元测试
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [ ] 4.2 实现 Account 主账户功能
    - 定义 Account、AccountStatus 结构体
    - 实现账户创建和基础信息管理
    - 实现头寸ID列表的管理功能
    - 实现等级和积分系统
    - 编写 Account 管理的单元测试
    - _需求: 2.7, 2.8, 2.9, 2.10, 2.11, 2.12_

  - [ ] 4.3 实现 AccountCap 权限控制系统
    - 定义 AccountCap 结构体为不可转让的 Owned object
    - 实现权限验证机制
    - 实现账户操作的权限检查
    - 编写权限控制的单元测试
    - _需求: 2.13, 2.14, 2.15, 2.16_

- [ ] 5. 实现 Account Module 的子账户和额度管理
  - [ ] 5.1 实现子账户管理系统
    - 定义 SubAccount、SubAccountCap 结构体
    - 实现子账户的创建和管理功能
    - 实现主账户与子账户的关联关系
    - 编写子账户管理的单元测试
    - _需求: 2.17, 2.18, 2.19, 2.20, 2.21, 2.22_

  - [ ] 5.2 实现额度授权管理系统
    - 定义 Allowance 结构体
    - 实现额度设置、检查和扣减功能
    - 实现不同类型额度的管理
    - 实现额度的实时查询和更新
    - 编写额度管理的单元测试
    - _需求: 2.23, 2.24, 2.25, 2.26, 2.27, 2.28_

  - [ ] 5.3 实现权限层级和安全控制
    - 实现主账户和子账户的权限层级关系
    - 实现权限冲突的处理机制
    - 实现账户暂停和恢复功能
    - 编写权限层级的单元测试
    - _需求: 2.29, 2.30, 2.31, 2.32_

- [ ] 6. 实现跨模块集成和数据一致性
  - [ ] 6.1 实现模块间的统一接口
    - 创建 Account Module 为 Liquidity Module 提供的身份验证接口
    - 实现跨模块的权限验证机制
    - 确保模块间数据传递的安全性
    - 编写跨模块接口的单元测试
    - _需求: 1.25, 1.26, 2.35, 2.36_

  - [ ] 6.2 实现数据一致性和并发控制
    - 实现多操作的原子性保证
    - 实现账户数据的一致性检查
    - 实现并发访问的安全控制
    - 编写并发操作的单元测试
    - _需求: 1.24, 1.25, 1.26, 2.33, 2.34_

- [ ] 7. 实现完整的测试套件和边界情况处理
  - [ ] 7.1 实现综合集成测试
    - 创建端到端的用户操作流程测试
    - 测试账户创建到资产存取的完整流程
    - 测试子账户创建和额度管理的完整流程
    - 测试多 Vault 切换和管理的完整流程
    - _需求: 1.11, 1.12, 2.1, 2.17_

  - [ ] 7.2 实现边界条件和错误处理测试
    - 测试所有错误码的触发条件
    - 测试极限值和边界条件
    - 测试异常情况的恢复机制
    - 测试安全攻击的防护机制
    - _需求: 1.16, 1.17, 1.18, 2.25, 2.26_

  - [ ] 7.3 实现性能和安全测试
    - 测试高并发操作的性能表现
    - 测试 gas 消耗的优化效果
    - 测试权限绕过和重入攻击的防护
    - 创建完整的测试报告和文档
    - _需求: 1.24, 1.25, 2.33, 2.34_

- [ ] 8. 完善文档和部署准备
  - 创建详细的 API 文档和使用示例
  - 编写部署脚本和初始化脚本
  - 创建用户操作指南和开发者文档
  - 进行最终的代码审查，确保符合 Move Book 代码质量标准
  - 验证所有代码都遵循既定的风格规范和最佳实践
  - _需求: 1.1, 2.1_
## 代码质
量要求

### 代码风格规范
本项目严格遵循 [Move Book 代码质量检查清单](https://move-book.com/guides/code-quality-checklist) 的所有要求：

#### 1. 命名规范
- **模块名**: 使用 snake_case，如 `liquidity`, `account`
- **结构体名**: 使用 PascalCase，如 `Registry`, `Vault`, `Account`
- **函数名**: 使用 snake_case，如 `create_vault`, `get_account`
- **错误常量名**: 使用 EPascalCase，如 `EVaultPaused`, `ENotAuthorized`
- **其他常量名**: 使用 SCREAMING_SNAKE_CASE，如 `MAX_SUPPLY`
- **变量名**: 使用 snake_case，如 `total_assets`, `user_account`

#### 2. Move 2024 版本要求
- **结构体定义**: 所有 struct 必须定义为 `public struct`，这是 Move 2024 版本后的强制要求
- **可见性**: 明确指定所有函数和结构体的可见性（public, public(package), entry 等）
- **类型参数**: 正确使用 phantom 类型参数

#### 3. 文档要求
- 所有 public 函数必须有详细的文档注释
- 所有结构体必须有说明其用途的注释
- 复杂的业务逻辑必须有内联注释解释
- 错误码必须有清晰的说明

#### 4. 错误处理
- 使用有意义的错误码和错误信息
- 所有可能失败的操作都必须有适当的错误处理
- 错误码按模块分组，避免冲突

#### 5. 安全最佳实践
- 所有 public 函数都必须进行输入验证
- 使用 `assert!` 进行前置条件检查
- 避免整数溢出和下溢
- 正确使用 `abort` 和错误码

#### 6. 性能优化
- 避免不必要的复制操作
- 合理使用引用和可变引用
- 优化 gas 消耗
- 避免深度嵌套的数据结构

#### 7. 测试覆盖
- 每个 public 函数都必须有对应的测试用例
- 测试必须覆盖正常流程和异常情况
- 边界条件测试
- 集成测试验证模块间交互

### 代码审查检查点
在每个任务完成时，必须检查以下项目：

1. **功能正确性**: 代码是否正确实现了需求
2. **风格一致性**: 是否遵循了命名规范和代码风格
3. **文档完整性**: 是否有充分的注释和文档
4. **错误处理**: 是否有适当的错误处理机制
5. **测试覆盖**: 是否有充分的测试用例
6. **安全性**: 是否遵循了安全最佳实践
7. **性能**: 是否考虑了 gas 优化和性能问题

### 质量门禁
- 所有测试必须通过
- 代码覆盖率必须达到 90% 以上
- 静态分析工具检查无警告
- 代码审查必须通过
- 文档必须完整且准确